### Что такое CAP-теорема? Простыми словами

CAP-теорема, также известная как **теорема Брюера** (по имени Эрика Брюера, который сформулировал ее в 2000 году), гласит, что в любой распределенной системе, управляющей данными, невозможно одновременно обеспечить более двух из трех следующих свойств:

1. **C**onsistency (Согласованность)
    
2. **A**vailability (Доступность)
    
3. **P**artition Tolerance (Устойчивость к разделению)
    

Проще говоря, это «выбери два из трех». Теорема описывает неизбежный компромисс, с которым сталкиваются разработчики при создании распределенных систем.

---

### Детальное объяснение трех свойств

Давайте разберем каждое свойство по отдельности.

#### 1. Consistency (Согласованность)

> **"Все узлы видят одни и те же данные в один и тот же момент времени."**

Это означает, что после выполнения операции записи (например, добавления нового поста), **все** последующие запросы на чтение (даже к другим узлам системы) должны вернуть это новое значение или ошибку. Система ведет себя как единое целое. Здесь речь идет о **линейной согласованности** — самом строгом виде.

- **Аналогия:** Представьте, что вы обновили свой профиль в социальной сети. Все ваши друзья, в какой бы точке мира они ни находились, должны сразу увидеть эти изменения. Не может быть такой ситуации, когда один видит старую фотографию, а другой — новую.
    

#### 2. Availability (Доступность)

> **"Каждый запрос (чтение или запись) к системе, который не завершился неудачей, получает ответ (успешный или нет)."**

Это гарантия того, что система **всегда отвечает** на запросы, независимо от состояния отдельных ее узлов. Даже если часть серверов "упала", оставшиеся в рабочем состоянии узлы продолжают обслуживать клиентов.

- **Аналогия:** Банкомат. Вы можете снять деньги в любом банкомате сети, даже если какой-то из них сломан. Главное — ваш запрос не будет "висеть" без ответа. Вы либо получите деньги, либо увидите сообщение "Недостаточно средств", либо "Банкомат не работает", но не будете ждать ответа минутами.
    

#### 3. Partition Tolerance (Устойчивость к разделению)

> **"Система продолжает работать, несмотря на произвольное количество потерь сообщений между узлами."**

"Раздел" (Partition) — это сбой в сети связи, который разделяет кластер на две или более частей, которые не могут общаться друг с другом. Устойчивость к разделению означает, что система способна пережить такие сетевые сбои и продолжать функционировать.

- **Аналогия:** Команда исследователей в джунглях с рациями. Если связь между двумя группами пропадает (возник "раздел"), каждая группа должна быть способна продолжать свою работу автономно, а не полностью парализоваться.
    

**Важный момент:** В реальном мире, особенно в системах, развернутых в нескольких дата-центрах или облаках, **сетевые разделы неизбежны**. Поэтому на практике свойство **P (Partition Tolerance) невозможно отказаться**. Это означает, что реальный выбор стоит между **C (Consistency)** и **A (Availability)**.

---

### Три возможных сценария согласно CAP-теореме

Поскольку отказаться от **P** в реальности нельзя, у нас есть два основных варианта построения системы:

#### 1. CP-системы (Consistency + Partition Tolerance)

> **Жертвуют доступностью (A) ради согласованности (C).**

Когда происходит сетевой раздел, узлы, оказавшиеся в меньшинстве (не имеющие кворума для принятия решений), перестают отвечать на запросы, чтобы не дать устаревшие или несогласованные данные. Они предпочитают вернуть ошибку, чем рисковать согласованностью.

- **Примеры:** Классические базы данных, такие как **MySQL Cluster**, **PostgreSQL** с синхронной репликацией, **MongoDB** (в определенных конфигурациях), **HBase**, **ZooKeeper**.
    
- **Аналогия:** Банковская операция по переводу крупной суммы. Если связь с головным офисом потеряна, операция будет отклонена, чтобы избежать двойного списания или других несогласованностей. Лучше не выполнить операцию, чем выполнить ее с ошибкой.
    

#### 2. AP-системы (Availability + Partition Tolerance)

> **Жертвуют согласованностью (C) ради доступности (A).**

Когда происходит раздел, все узлы продолжают отвечать на запросы. Однако, поскольку узлы не могут синхронизироваться, клиенты могут получать устаревшие данные. После устранения раздела система должна разрешить возникшие конфликты.

- **Примеры:** **Cassandra**, **DynamoDB**, **Riak**, **Voldemort**. Часто используются в системах, где скорость ответа и доступность критичны, а небольшая задержка в актуальности данных допустима.
    
- **Аналогия:** Система кэширования веб-страниц или корзина покупок в интернет-магазине. Если один из серверов "отвалился", вы все равно можете добавлять товары в корзину (данные запишутся на другой сервер), даже если какое-то время вы не увидите товар, добавленный с другого устройства. В конечном счете данные синхронизируются.
    

#### 3. CA-системы (Consistency + Availability)

> **Жертвуют устойчивостью к разделению (P).**

Такие системы могут существовать только в идеальных условиях, где сетевые сбои невозможны. На практике это обычно **одиночные узлы** (не распределенные системы) или системы, работающие в пределах одного дата-центра с идеальной сетью (что является абстракцией). В реальном распределенном мире CA-систем не существует.

- **Примеры:** Отдельно стоящие базы данных, такие как **PostgreSQL** или **MySQL** на одном сервере. Как только вы добавляете реплики для распределенности, вы немедленно сталкиваетесь с проблемой CAP.
    

---

### Распространенные заблуждения и уточнения

1. **"CAP-теорема — это жесткое правило на все случаи жизни."**
    
    - **Нет.** Это упрощенная модель, которая помогает думать о компромиссах. В реальных системах все сложнее. Например, есть понятие **PACELC**, которое расширяет CAP, добавляя компромиссы между **Latency** (задержкой) и **Consistency** (согласованностью) в нормальных условиях (без разделов).
        
2. **"Во время раздела я полностью теряю либо C, либо A."**
    
    - **Не совсем.** В CP-системах доступность теряется только для части узлов (тех, что в "меньшинстве"). В AP-системах согласованность нарушается только для некоторых данных на время раздела. После устранения раздела система возвращается в полностью согласованное состояние.
        
3. **"Можно обойти CAP-теорему."**
    
    - **Нет, нельзя.** Это теорема, которая была строго математически доказана (Сетом Гилбертом и Нэнси Линч в 2002 году). Она описывает фундаментальное ограничение распределенных систем.
        

### Заключение

CAP-теорема — это не инструкция о том, какую систему выбрать, а **инструмент для осознанного проектирования**. Выбор между CP и AP зависит от требований вашего приложения:

- **Выберите CP**, если корректность данных критически важна (финансовые системы, системы бронирования).
    
- **Выберите AP**, если важнее всего скорость ответа и бесперебойная работа, а небольшая задержка в актуальности данных допустима (социальные сети, ленты новостей, онлайн-ритейл).
    

Понимание CAP-теоремы — это первый шаг к созданию надежных и предсказуемых распределенных приложений.